<header class="pb-md-4 pb-0" th:fragment="headerClient" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background-color:#ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <div class="header-top">
        <div class="container-fluid-lg">
            <div class="row">
                <div class="col-xxl-3 d-xxl-block d-none">
                    <div class="top-left-header">
                        <i class="iconly-Location icli text-white"></i>
                        <span class="text-white">Only Online</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="top-nav top-header sticky-header" >
        <div class="container-fluid-lg">
            <div class="row">
                <div class="col-12">
                    <div class="navbar-top">
                        <button class="navbar-toggler d-xl-none d-inline navbar-menu-button" type="button"
                                data-bs-toggle="offcanvas" data-bs-target="#primaryMenu">
                                <span class="navbar-toggler-icon">
                                    <i class="fa-solid fa-bars"></i>
                                </span>
                        </button>
                        <a th:href="@{/}" class="web-logo nav-logo">
                            <img src="../assets/images/logo/1.png" class="img-fluid blur-up lazyload" alt="">
                        </a>

                        <div class="middle-box">

                            <div class="search-box">
                                <div class="input-group">
                                    <input type="search" class="form-control" placeholder="I'm searching for...">
                                    <button class="btn" type="button" id="button-addon2">
                                        <i data-feather="search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="rightside-box">
                            <div class="search-full">
                                <div class="input-group">
                                        <span class="input-group-text">
                                            <i data-feather="search" class="font-light"></i>
                                        </span>
                                    <input type="text" class="form-control search-type" placeholder="Search here..">
                                    <span class="input-group-text close-search">
                                            <i data-feather="x" class="font-light"></i>
                                        </span>
                                </div>
                            </div>
                            <ul class="right-side-menu">
                                <li class="right-side">
                                    <div class="delivery-login-box">
                                        <div class="delivery-icon">
                                            <div class="search-box">
                                                <i data-feather="search"></i>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li class="right-side">
                                    <a href="contact-us.html" class="delivery-login-box">
                                        <div class="delivery-icon">
                                            <i data-feather="phone-call"></i>
                                        </div>
                                        <div class="delivery-detail">
                                            <h6>24/7 Delivery</h6>
                                            <h5>+84 394835938</h5>
                                        </div>
                                    </a>
                                </li>
                                <li class="right-side">
                                    <a href="wishlist.html" class="btn p-0 position-relative header-wishlist">
                                        <i data-feather="heart"></i>
                                    </a>
                                </li>
                                <li class="right-side">
                                    <div class="onhover-dropdown header-badge">
                                        <button type="button" class="btn p-0 position-relative header-wishlist">
                                            <i data-feather="shopping-cart"></i>
                                            <span class="position-absolute top-0 start-100 translate-middle badge" id="totalProduct">
                                                    <span class="visually-hidden">unread messages</span>
                                                </span>
                                        </button>

                                        <div class="onhover-div" id="lsCartHeader">

                                        </div>
                                    </div>
                                </li>
                                <li class="right-side onhover-dropdown">
                                    <div class="delivery-login-box">


                                            <div sec:authorize="isAuthenticated()">
                                                <h5 th:text="${#authentication.principal.getFullName()}"></h5>
                                            </div>
                                            <div sec:authorize="!isAuthenticated()">
                                                <div class="delivery-icon">
                                                    <i data-feather="user"></i>
                                                </div>
                                            </div>
                                    </div>

                                    <div class="onhover-div onhover-div-login">
                                        <ul class="user-box-name">
                                            <div sec:authorize="!isAuthenticated()">

                                                <li class="product-box-contain">
                                                    <i></i>
                                                    <a th:href="@{/login}">Log In</a>
                                                </li>
                                            </div>

                                            <div sec:authorize="isAuthenticated()">

                                                <li class="product-box-contain">
                                                    <i></i>
                                                    <a th:href="@{/user/dashboard}">My Account</a>
                                                </li>
                                                <li class="product-box-contain">
                                                    <i></i>
                                                    <a th:href="@{/logout}">Log Out</a>
                                                </li>
                                            </div>

                                            <li class="product-box-contain">
                                                <a href="sign-up.html" th:href="@{/sign-up}">Register</a>
                                            </li>

                                            <li class="product-box-contain">
                                                <a href="forgot.html">Forgot Password</a>
                                            </li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid-lg">
        <div class="row">
            <div class="col-12">
                <div class="header-nav">
                    <div class="header-nav-left">
                        <button class="dropdown-category">
                            <i data-feather="align-left"></i>
                            <span>Categories</span>
                        </button>

                        <div class="category-dropdown">
                            <div class="category-title">
                                <h5>Categories</h5>
                                <button type="button" class="btn p-0 close-button text-content">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>

                            <ul class="category-list">
                                <li class="onhover-category-list" th:each="category:${categories}">
                                    <a href="javascript:void(0)" class="category-name">
                                        <img src="../assets/images/Flower/logo.jpg" alt="">
                                        <h6 th:text ="${category.categoryName}">Vegetables & Fruit</h6>

                                    </a>


                                </li>

                            </ul>
                        </div>
                    </div>

                    <div class="header-nav-middle">
                        <div class="main-nav navbar navbar-expand-xl navbar-light navbar-sticky">
                            <div class="offcanvas offcanvas-collapse order-xl-2" id="primaryMenu">
                                <div class="offcanvas-header navbar-shadow">
                                    <h5>Menu</h5>
                                    <button class="btn-close lead" type="button"
                                            data-bs-dismiss="offcanvas"></button>
                                </div>
                                <div class="offcanvas-body">
                                    <ul class="navbar-nav">
                                        <li class="nav-item dropdown">
                                            <a class="nav-link dropdown-toggle" href="javascript:void(0)"
                                               data-bs-toggle="dropdown">Home</a>

                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a class="dropdown-item" th:href="@{/}">Kartshop</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-2.html">Sweetshop</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-3.html">Organic</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-4.html">Supershop</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-5.html">Classic shop</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-6.html">Furniture</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-7.html">Search Oriented</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-8.html">Category Focus</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-9.html">Fashion</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-10.html">Book</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="index-11.html">Digital</a>
                                                </li>
                                            </ul>
                                        </li>

                                        <li class="nav-item dropdown">
                                            <a class="nav-link dropdown-toggle" href="javascript:void(0)"
                                               data-bs-toggle="dropdown">Shop</a>

                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a class="dropdown-item" href="shop-category-slider.html">Shop
                                                        Category Slider</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="shop-category.html">Shop
                                                        Category Sidebar</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="shop-banner.html">Shop Banner</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="shop-left-sidebar.html">Shop Left
                                                        Sidebar</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="shop-list.html">Shop List</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="shop-right-sidebar.html">Shop
                                                        Right Sidebar</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="shop-top-filter.html">Shop Top
                                                        Filter</a>
                                                </li>
                                            </ul>
                                        </li>

                                        <li class="nav-item dropdown">
                                            <a class="nav-link dropdown-toggle" href="javascript:void(0)"
                                               data-bs-toggle="dropdown">Product</a>

                                            <div class="dropdown-menu dropdown-menu-3 dropdown-menu-2">
                                                <div class="row">
                                                    <div class="col-xl-3">
                                                        <div class="dropdown-column m-0">
                                                            <h5 class="dropdown-header">
                                                                Product Pages </h5>
                                                            <a class="dropdown-item"
                                                               href="product-left-thumbnail.html">Product
                                                                Thumbnail</a>
                                                            <a class="dropdown-item"
                                                               href="product-4-image.html">Product Images</a>
                                                            <a class="dropdown-item"
                                                               href="product-slider.html">Product Slider</a>
                                                            <a class="dropdown-item"
                                                               href="product-sticky.html">Product Sticky</a>
                                                            <a class="dropdown-item"
                                                               href="product-accordion.html">Product Accordion</a>
                                                            <a class="dropdown-item"
                                                               href="product-circle.html">Product Tab</a>
                                                            <a class="dropdown-item"
                                                               href="product-digital.html">Product Digital</a>

                                                            <h5 class="custom-mt dropdown-header">Product Features
                                                            </h5>
                                                            <a class="dropdown-item"
                                                               href="product-circle.html">Bundle (Cross Sale)</a>
                                                            <a class="dropdown-item"
                                                               href="product-left-thumbnail.html">Hot Stock
                                                                Progress <label class="menu-label">New</label>
                                                            </a>
                                                            <a class="dropdown-item"
                                                               href="product-sold-out.html">SOLD OUT</a>
                                                            <a class="dropdown-item" href="product-circle.html">
                                                                Sale Countdown</a>
                                                        </div>
                                                    </div>
                                                    <div class="col-xl-3">
                                                        <div class="dropdown-column m-0">
                                                            <h5 class="dropdown-header">
                                                                Product Variants Style </h5>
                                                            <a class="dropdown-item"
                                                               href="product-rectangle.html">Variant Rectangle</a>
                                                            <a class="dropdown-item"
                                                               href="product-circle.html">Variant Circle <label
                                                                    class="menu-label">New</label></a>
                                                            <a class="dropdown-item"
                                                               href="product-color-image.html">Variant Image
                                                                Swatch</a>
                                                            <a class="dropdown-item"
                                                               href="product-color.html">Variant Color</a>
                                                            <a class="dropdown-item"
                                                               href="product-radio.html">Variant Radio Button</a>
                                                            <a class="dropdown-item"
                                                               href="product-dropdown.html">Variant Dropdown</a>
                                                            <h5 class="custom-mt dropdown-header">Product Features
                                                            </h5>
                                                            <a class="dropdown-item"
                                                               href="product-left-thumbnail.html">Sticky
                                                                Checkout</a>
                                                            <a class="dropdown-item"
                                                               href="product-dynamic.html">Dynamic Checkout</a>
                                                            <a class="dropdown-item"
                                                               href="product-sticky.html">Secure Checkout</a>
                                                            <a class="dropdown-item"
                                                               href="product-bundle.html">Active Product view</a>
                                                            <a class="dropdown-item" href="product-bundle.html">
                                                                Active
                                                                Last Orders
                                                            </a>
                                                        </div>
                                                    </div>
                                                    <div class="col-xl-3">
                                                        <div class="dropdown-column m-0">
                                                            <h5 class="dropdown-header">
                                                                Product Features </h5>
                                                            <a class="dropdown-item"
                                                               href="product-image.html">Product Simple</a>
                                                            <a class="dropdown-item" href="product-rectangle.html">
                                                                Product Classified <label
                                                                    class="menu-label">New</label>
                                                            </a>
                                                            <a class="dropdown-item"
                                                               href="product-size-chart.html">Size Chart <label
                                                                    class="menu-label">New</label></a>
                                                            <a class="dropdown-item"
                                                               href="product-size-chart.html">Delivery &
                                                                Return</a>
                                                            <a class="dropdown-item"
                                                               href="product-size-chart.html">Product Review</a>
                                                            <a class="dropdown-item" href="product-expert.html">Ask
                                                                an Expert</a>
                                                            <h5 class="custom-mt dropdown-header">Product Features
                                                            </h5>
                                                            <a class="dropdown-item"
                                                               href="product-bottom-thumbnail.html">Product
                                                                Tags</a>
                                                            <a class="dropdown-item" href="product-image.html">Store
                                                                Information</a>
                                                            <a class="dropdown-item"
                                                               href="product-image.html">Social Share <label
                                                                    class="menu-label warning-label">Hot</label>
                                                            </a>
                                                            <a class="dropdown-item"
                                                               href="product-left-thumbnail.html">Related Products
                                                                <label class="menu-label warning-label">Hot</label>
                                                            </a>
                                                            <a class="dropdown-item"
                                                               href="product-right-thumbnail.html">Wishlist &
                                                                Compare</a>
                                                        </div>
                                                    </div>
                                                    <div class="col-xl-3 d-xl-block d-none">
                                                        <div class="dropdown-column m-0">
                                                            <div class="menu-img-banner">
                                                                <a class="text-title" href="product-circle.html">
                                                                    <img src="../assets/images/mega-menu.png"
                                                                         alt="banner">
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>

                                        <li class="nav-item dropdown new-nav-item">
                                            <label class="new-dropdown">New</label>
                                            <a class="nav-link dropdown-toggle" href="javascript:void(0)"
                                               data-bs-toggle="dropdown">Pages</a>
                                            <ul class="dropdown-menu">
                                                <li class="sub-dropdown-hover">
                                                    <a class="dropdown-item" href="javascript:void(0)">Email
                                                        Template <span class="new-text"><i
                                                                class="fa-solid fa-bolt-lightning"></i></span></a>
                                                    <ul class="sub-menu">
                                                        <li>
                                                            <a
                                                                    href="../email-templete/abandonment-email.html">Abandonment</a>
                                                        </li>
                                                        <li>
                                                            <a href="../email-templete/offer-template.html">Offer
                                                                Template</a>
                                                        </li>
                                                        <li>
                                                            <a href="../email-templete/order-success-2.html">Order
                                                                Success</a>
                                                        </li>
                                                        <li>
                                                            <a href="../email-templete/reset-password-2.html">Reset
                                                                Password</a>
                                                        </li>
                                                        <li>
                                                            <a href="../email-templete/welcome-2.html">Welcome
                                                                template</a>
                                                        </li>
                                                    </ul>
                                                </li>
                                                <li class="sub-dropdown-hover">
                                                    <a class="dropdown-item" href="javascript:void(0)">Invoice
                                                        Template <span class="new-text"><i
                                                                class="fa-solid fa-bolt-lightning"></i></span></a>
                                                    <ul class="sub-menu">
                                                        <li>
                                                            <a href="../invoice/invoice-1.html">Invoice 1</a>
                                                        </li>

                                                        <li>
                                                            <a href="../invoice/invoice-2.html">Invoice 2</a>
                                                        </li>

                                                        <li>
                                                            <a href="../invoice/invoice-3.html">Invoice 3</a>
                                                        </li>
                                                    </ul>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="404.html">404</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="about-us.html">About Us</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="cart.html">Cart</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="contact-us.html">Contact</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="checkout.html">Checkout</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="coming-soon.html">Coming Soon</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="compare.html">Compare</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="faq.html">Faq</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="order-success.html">Order
                                                        Success</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="order-tracking.html">Order
                                                        Tracking</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="otp.html">OTP</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="search.html">Search</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="user-dashboard.html">User
                                                        Dashboard</a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="wishlist.html">Wishlist</a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        document.addEventListener('DOMContentLoaded',LoadLsCartHeader);
        async function LoadLsCartHeader(){
            const  lsCartHeader = document.getElementById('lsCartHeader');
            const  totalProduct = document.getElementById('totalProduct');
            try{
                const response = await  fetch('/cart/getlsCart');
                const lsCart = await response.json();

                if(!lsCart || lsCart.length === 0){ // Sửa: Dùng .length
                    lsCartHeader.innerHTML= "Your cart is empty.";
                    totalProduct.innerText = 0; // Thêm: Đặt tổng sản phẩm về 0
                    return;
                }

                // Hiển thị tổng số *loại* sản phẩm (đây là logic cũ của bạn, giữ nguyên)
                totalProduct.innerText =lsCart.length;

                // --- PHẦN CHỈNH SỬA ---

                // 1. Tính toán tổng tiền và tổng số lượng từ TOÀN BỘ giỏ hàng
                let total = 0;
                let totalQuantity = 0;
                lsCart.forEach(item => {
                    total += item.totalPrice;
                    totalQuantity += item.quantityCart;
                });

                // 2. Lấy 5 sản phẩm đầu tiên để hiển thị
                const itemsToDisplay = lsCart.slice(0, 5);

                // 3. Tạo HTML chỉ từ 5 sản phẩm đó
                // (Tôi cũng đã sửa lại cấu trúc HTML của bạn một chút,
                // bạn đang lặp <ul> thay vì <li>, gây lỗi HTML)
                const itemHtml = itemsToDisplay.map(item => {
                    // Không cần tính tổng ở đây nữa
                    return `
                        <li class="product-box-contain">
                            <div class="drop-cart">
                                <a href="product-left-thumbnail.html" class="drop-image">
                                    <img src="${item.productImage}"
                                         class="blur-up lazyload" alt="">
                                </a>

                                <div class="drop-contain">
                                    <a href="product-left-thumbnail.html">
                                        <h5>${item.productName}</h5>
                                    </a>
                                    <h6><span>${item.quantityCart}X</span> ${item.productPrice}</h6>
                                    <button class="close-button close_button" onclick="removeItem(${item.productId})">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                        </li>
                    `; // Sửa: Chỉ trả về <li>, bỏ <ul> thừa
                }).join('');

                // 4. Hiển thị danh sách 5 sản phẩm, nhưng với tổng tiền/số lượng của CẢ GIỎ HÀNG
                lsCartHeader.innerHTML =` <ul class="cart-list">
                                            ${itemHtml}
                                            </ul>

                                            <div class="price-box">
                                                <h5>Total : </h5>
                                                <h4 class="theme-color fw-bold">${total}</h4>
                                            </div>

                                            <div class="button-group">
                                                <a href="/cart" class="btn btn-sm cart-button">View Cart (${totalQuantity})</a>

                                            </div>
                `
                // --- KẾT THÚC PHẦN CHỈNH SỬA ---

            }catch (error) {
                console.log(error);

            }
        }

        // ... (Các hàm còn lại của bạn giữ nguyên) ...

        function removeItem(productId) {
            console.log("removeItem:", productId);
            try {
                fetch('/cart/removeItem'
                    + '?productId=' + productId
                ).then(response => response.text())
                    .then(data => {
                        LoadLsCartHeader();
                    })
            } catch (error) {
                console.log(error);
            }
        }
        async function addToCartItem(productId, quantity) {
            console.log("productId"+ productId + " quantity " + quantity);
            if (quantity < 1) {
                alert("Quantity must be greater than 0");
                return;
            }
            try {
                const response = await fetch(`/cart/addToCart?productId=${productId}&quantity=${quantity}`)
                if(response.ok){
                    await LoadLsCartHeader();

                    showAlert('Added to cart successfully!', 'success', 'top-right', 2000);
                }
            } catch (error) {
                console.log(error);
            }


        }


        function showAlert(message, type = 'info', position = 'top-right', timeout = 3000) {

            const map = {
                'top-right': document.getElementById('alerts-top-right'),
                'top-left': document.getElementById('alerts-top-left'),
                'bottom-right': document.getElementById('alerts-bottom-right'),
                'bottom-left': document.getElementById('alerts-bottom-left')
            };
            const container = map[position] || map['top-right'];

            // Tạo element alert bootstrappy
            const wrapper = document.createElement('div');
            wrapper.className = `alert alert-${type} d-flex align-items-start`;
            wrapper.setAttribute('role', 'alert');
            wrapper.innerHTML = `
        <div class="me-2 flex-grow-1">${message}</div>
        <button type="button" class="btn-close" aria-label="Close"></button>
      `;

            // ban đầu gán class enter để nó bắt đầu ngoài màn hình
            wrapper.classList.add('enter');

            // append vào container
            container.appendChild(wrapper);

            // Force reflow rồi thêm class showing để chạy transition vào
            // (setTimeout 0 để đảm bảo transition được kích hoạt)
            requestAnimationFrame(() => {
                wrapper.classList.add('showing');
                wrapper.classList.remove('enter');
            });

            // đóng khi click nút close
            const closeBtn = wrapper.querySelector('.btn-close');
            closeBtn.addEventListener('click', () => hideAlert(wrapper, container));

            // Nếu timeout > 0 -> tự ẩn
            if (timeout && timeout > 0) {
                // tăng timeout nhỏ trước khi hide để hiển thị đủ animation
                setTimeout(() => hideAlert(wrapper, container), timeout);
            }
        }

        // Ẩn alert với animation rồi remove khỏi DOM
        function hideAlert(el, container) {
            // tránh gọi nhiều lần
            if (!el || el.dataset.hiding === '1') return;
            el.dataset.hiding = '1';

            el.classList.remove('showing');
            el.classList.add('hiding');

            // sau transition, remove node
            // thời gian này nên khớp với CSS transition (khoảng 400ms)
            setTimeout(() => {
                if (container.contains(el)) container.removeChild(el);
            }, 450);
        }
    </script>



</header >

