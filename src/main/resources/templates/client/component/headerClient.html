<header class="pb-md-4 pb-0" th:fragment="headerClient" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background-color:#ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);border-top: 1px solid #cfcfcf;">

    <div class="top-nav top-header sticky-header">
        <div class="container-fluid-lg">
            <div class="row">
                <div class="col-12">
                    <div class="navbar-top">
                        <button class="navbar-toggler d-xl-none d-inline navbar-menu-button" type="button"
                            data-bs-toggle="offcanvas" data-bs-target="#primaryMenu">
                            <span class="navbar-toggler-icon">
                                <i class="fa-solid fa-bars"></i>
                            </span>
                        </button>
                        <a th:href="@{/}" class="web-logo nav-logo">
                            <img src="../assets/images/logo/1.png" class="img-fluid blur-up lazyload" alt="">
                        </a>

                        <div class="middle-box">

                            <div class="search-box">
                                <div class="input-group">
                                    <input type="search" class="form-control" placeholder="I'm searching for...">
                                    <button class="btn" type="button" id="button-addon2">
                                        <i data-feather="search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="rightside-box">
                            <div class="search-full">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i data-feather="search" class="font-light"></i>
                                    </span>
                                    <input type="text" class="form-control search-type" placeholder="Search here..">
                                    <span class="input-group-text close-search">
                                        <i data-feather="x" class="font-light"></i>
                                    </span>
                                </div>
                            </div>
                            <ul class="right-side-menu">
                                <li class="right-side">
                                    <div class="delivery-login-box">
                                        <div class="delivery-icon">
                                            <div class="search-box">
                                                <i data-feather="search"></i>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li class="right-side">
                                    <a href="contact-us.html" class="delivery-login-box">
                                        <div class="delivery-icon">
                                            <i data-feather="phone-call"></i>
                                        </div>
                                        <div class="delivery-detail">
                                            <h6>24/7 Delivery</h6>
                                            <h5>+84 394835938</h5>
                                        </div>
                                    </a>
                                </li>
                                <li class="right-side">
                                    <a href="wishlist.html" class="btn p-0 position-relative header-wishlist">
                                        <i data-feather="heart"></i>
                                    </a>
                                </li>
                                <li class="right-side">
                                    <div class="onhover-dropdown header-badge">
                                        <button type="button" class="btn p-0 position-relative header-wishlist">
                                            <i data-feather="shopping-cart"></i>
                                            <span class="position-absolute top-0 start-100 translate-middle badge"
                                                id="totalProduct">
                                                <span class="visually-hidden">unread messages</span>
                                            </span>
                                        </button>

                                        <div class="onhover-div" id="lsCartHeader">

                                        </div>
                                    </div>
                                </li>
                                <li class="right-side onhover-dropdown">
                                    <div class="delivery-login-box">


                                        <div sec:authorize="isAuthenticated()">
                                            <h5 th:text="${#authentication.principal.getFullName()}"></h5>
                                        </div>
                                        <div sec:authorize="!isAuthenticated()">
                                            <div class="delivery-icon">
                                                <i data-feather="user"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="onhover-div onhover-div-login">
                                        <ul class="user-box-name">
                                            <div sec:authorize="!isAuthenticated()">

                                                <li class="product-box-contain">
                                                    <i></i>
                                                    <a th:href="@{/login}">Log In</a>
                                                </li>
                                                <li class="product-box-contain">
                                                    <a href="sign-up.html" th:href="@{/sign-up}">Register</a>
                                                </li>

                                                <li class="product-box-contain">
                                                    <a href="forgot.html" th:href="@{/forgot}">Forgot Password</a>
                                                </li>
                                            </div>

                                            <div sec:authorize="isAuthenticated()">

                                                <li class="product-box-contain">
                                                    <i></i>
                                                    <a th:href="@{/user/dashboard}">My Account</a>
                                                </li>
                                                <li class="product-box-contain">
                                                    <i></i>
                                                    <a th:href="@{/logout}">Log Out</a>
                                                </li>
                                            </div>


                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid-lg">
        <div class="row">
            <div class="col-12">
                <div class="header-nav">
                    <div class="header-nav-left">
                        <button class="dropdown-category">
                            <i data-feather="align-left"></i>
                            <span>Categories</span>
                        </button>

                        <div class="category-dropdown">
                            <div class="category-title">
                                <h5>Categories</h5>
                                <button type="button" class="btn p-0 close-button text-content">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>

                            <ul class="category-list">
                                <li class="onhover-category-list" th:each="category:${categories}">
                                    <a th:href="@{/flower(categoryIDs=${category.categoryId})}" class="category-name">
                                        <img src="../assets/images/Flower/logo.jpg" alt="">
                                        <h6 th:text="${category.categoryName}">Vegetables & Fruit</h6>

                                    </a>


                                </li>

                            </ul>
                        </div>
                    </div>

                    <div class="header-nav-middle">
                        <div class="main-nav navbar navbar-expand-xl navbar-light navbar-sticky">
                            <div class="offcanvas offcanvas-collapse order-xl-2" id="primaryMenu">
                                <div class="offcanvas-header navbar-shadow">
                                    <h5>Menu</h5>
                                    <button class="btn-close lead" type="button" data-bs-dismiss="offcanvas"></button>
                                </div>
                                <div class="offcanvas-body">
                                    <ul class="navbar-nav">
                                        <li class="nav-item">
                                            <a class="" style="font-size: 18px" data-bs-toggle=""
                                                th:href="@{/}">Home</a>


                                        </li>

                                        <li class="nav-item">
                                            <a class=" " style="font-size: 18px" th:href="@{/flower}"
                                                href="javascript:void(0)" data-bs-toggle="">Shop</a>


                                        </li>

                                        <li class="nav-item dropdown">
                                            <a class="" style="font-size: 18px" href="javascript:void(0)"
                                                data-bs-toggle="">Product</a>


                                        </li>

                                        <li class="nav-item dropdown new-nav-item">

                                            <a class="" style="font-size: 18px" href="javascript:void(0)"
                                                data-bs-toggle="">Pages</a>

                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        document.addEventListener('DOMContentLoaded', LoadLsCartHeader);
        async function LoadLsCartHeader() {
            const lsCartHeader = document.getElementById('lsCartHeader');
            const totalProduct = document.getElementById('totalProduct');
            try {
                const response = await fetch('/cart/getlsCart');
                const lsCart = await response.json();

                if (!lsCart || lsCart.length === 0) { // Sửa: Dùng .length
                    lsCartHeader.innerHTML = "Your cart is empty.";
                    totalProduct.innerText = 0; // Thêm: Đặt tổng sản phẩm về 0
                    return;
                }

                // Hiển thị tổng số *loại* sản phẩm (đây là logic cũ của bạn, giữ nguyên)
                totalProduct.innerText = lsCart.length;

                // --- PHẦN CHỈNH SỬA ---

                // 1. Tính toán tổng tiền và tổng số lượng từ TOÀN BỘ giỏ hàng
                let total = 0;
                let totalQuantity = 0;
                lsCart.forEach(item => {
                    total += item.totalPrice;
                    totalQuantity += item.quantityCart;
                });

                // 2. Lấy 5 sản phẩm đầu tiên để hiển thị
                const itemsToDisplay = lsCart.slice(0, 5);

                // 3. Tạo HTML chỉ từ 5 sản phẩm đó
                // (Tôi cũng đã sửa lại cấu trúc HTML của bạn một chút,
                // bạn đang lặp <ul> thay vì <li>, gây lỗi HTML)
                const itemHtml = itemsToDisplay.map(item => {
                    // Không cần tính tổng ở đây nữa
                    return `
                        <li class="product-box-contain">
                            <div class="drop-cart">
                                <a href="product-left-thumbnail.html" class="drop-image">
                                    <img src="${item.productImage}"
                                         class="blur-up lazyload" alt="">
                                </a>

                                <div class="drop-contain">
                                    <a href="/product-detail/${item.productId}">
                                        <h5>${item.productName}</h5>
                                    </a>
                                    <h6><span>${item.quantityCart}X</span> ${item.productPrice}</h6>
                                    <button class="close-button close_button" onclick="removeItem(${item.productId})">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                        </li>
                    `; // Sửa: Chỉ trả về <li>, bỏ <ul> thừa
                }).join('');

                // 4. Hiển thị danh sách 5 sản phẩm, nhưng với tổng tiền/số lượng của CẢ GIỎ HÀNG
                lsCartHeader.innerHTML = ` <ul class="cart-list">
                                            ${itemHtml}
                                            </ul>

                                            <div class="price-box">
                                                <h5>Total : </h5>
                                                <h4 class="theme-color fw-bold">${total}</h4>
                                            </div>

                                            <div class="button-group">
                                                <a href="/cart" class="btn btn-sm cart-button">View Cart (${totalQuantity})</a>

                                            </div>
                `
                // --- KẾT THÚC PHẦN CHỈNH SỬA ---

            } catch (error) {
                console.log(error);

            }
        }

        // ... (Các hàm còn lại của bạn giữ nguyên) ...

        function removeItem(productId) {
            console.log("removeItem:", productId);
            try {
                fetch('/cart/removeItem'
                    + '?productId=' + productId
                ).then(response => response.text())
                    .then(data => {
                        LoadLsCartHeader();
                    })
            } catch (error) {
                console.log(error);
            }
        }
        async function addToCartItem(productId, quantity) {
            console.log("productId" + productId + " quantity " + quantity);
            if (quantity < 1) {
                alert("Quantity must be greater than 0");
                return;
            }
            try {
                const response = await fetch(`/cart/addToCart?productId=${productId}&quantity=${quantity}`);
                const data = await response.json(); // ✅ Đọc phản hồi JSON từ CartController

                if (response.ok && data.status === 'success') {
                    await LoadLsCartHeader();
                    // ✅ Dòng này sẽ hiển thị thông báo
                    showAlert('Added to cart successfully!', 'success', 'top-right', 2000);
                } else {
                    // ✅ Hiển thị thông báo lỗi từ backend (ví dụ: hết hàng)
                    showAlert(data.message || 'Failed to add item to cart.', 'danger', 'top-right', 3000);
                }
            } catch (error) {
                console.log(error);
                showAlert('An error occurred. Please try again.', 'danger', 'top-right', 3000);
            }
        }


        function showAlert(message, type = 'info', position = 'top-right', timeout = 3000) {

            const map = {
                'top-right': document.getElementById('alerts-top-right'),
                'top-left': document.getElementById('alerts-top-left'),
                'bottom-right': document.getElementById('alerts-bottom-right'),
                'bottom-left': document.getElementById('alerts-bottom-left')
            };
            const container = map[position] || map['top-right'];

            // Tạo element alert bootstrappy
            const wrapper = document.createElement('div');
            wrapper.className = `alert alert-${type} d-flex align-items-start`;
            wrapper.setAttribute('role', 'alert');
            wrapper.innerHTML = `
        <div class="me-2 flex-grow-1">${message}</div>
        <button type="button" class="btn-close" aria-label="Close"></button>
      `;

            // ban đầu gán class enter để nó bắt đầu ngoài màn hình
            wrapper.classList.add('enter');

            // append vào container
            container.appendChild(wrapper);

            // Force reflow rồi thêm class showing để chạy transition vào
            // (setTimeout 0 để đảm bảo transition được kích hoạt)
            requestAnimationFrame(() => {
                wrapper.classList.add('showing');
                wrapper.classList.remove('enter');
            });

            // đóng khi click nút close
            const closeBtn = wrapper.querySelector('.btn-close');
            closeBtn.addEventListener('click', () => hideAlert(wrapper, container));

            // Nếu timeout > 0 -> tự ẩn
            if (timeout && timeout > 0) {
                // tăng timeout nhỏ trước khi hide để hiển thị đủ animation
                setTimeout(() => hideAlert(wrapper, container), timeout);
            }
        }

        // Ẩn alert với animation rồi remove khỏi DOM
        function hideAlert(el, container) {
            // tránh gọi nhiều lần
            if (!el || el.dataset.hiding === '1') return;
            el.dataset.hiding = '1';

            el.classList.remove('showing');
            el.classList.add('hiding');

            // sau transition, remove node
            // thời gian này nên khớp với CSS transition (khoảng 400ms)
            setTimeout(() => {
                if (container.contains(el)) container.removeChild(el);
            }, 450);
        }
    </script>



</header>